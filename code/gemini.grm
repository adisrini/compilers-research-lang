%%
%term
    EOF
  | DATATYPE | TYPE | VAL | REF | FUN | MODULE | STRUCTURE | STRUCT | SIGNATURE | SIG | LIST
  | LET | IN | END | IF | THEN | ELSE
  | ORELSE | ANDALSO | NOT
  | NIL | WITH | OF | OP
  | BIT_NOT | BIT_OR | BIT_AND | BIT_XOR | BIT_SLL | BIT_SRL | BIT_SRA
  | GE | GT | LE | LT | NEQ | EQ
  | INT_DIVIDE | INT_TIMES | INT_PLUS | INT_MINUS | INT_MOD | REAL_DIVIDE | REAL_TIMES | REAL_PLUS | REAL_MINUS
  | RBRACE | LBRACE | RBRACK | LBRACK | RPAREN | LPAREN
  | DOT | SEMICOLON | COLON | COMMA | POUND | AT | TICK | ASSIGN | PIPE
  | ID of string | INT of int | STRING of string | REAL of real | BIT of Bit.bit
  | UMINUS

%nonterm  program
        | exp
            | lvalue
                | subscript
                | field
            | operation
                | int_op
                | real_op
                | bit_op
                | compare_op
            | let_block
                | let_body
                    | semicolon_exp0
                | decs
                    | val_dec
                    | fun_dec
                        | fun_dec_no_type
                        | fun_dec_with_type
                        | fun_params
                            | fun_param
                    | ty_dec
                        | ty
                            | ty_fields
                            | ty_field_tail
                    | dataty_dec
                    | module_dec
                    | non_fun_dec
                    | non_ty_dec
                    | non_dataty_dec
                    | non_module_dec
            | exp_seq
                | semicolon_exp1
            | assign
            | fun_call
                | call_params
                | call_param
                | exp_comma_tail
            | conditional
            | insts
            | rec_inst
                | rec_inst_body
                | rec_field_comma_tail
            | ref_inst
            | array_inst
                | array_index_fn
                | index_fn_tail
            | list_inst
                | list_elements
        | epsilon

%pos int
%verbose
%start program
%eop EOF
%noshift EOF

%name Gemini

%keyword DATATYPE TYPE VAL REF FUN MODULE STRUCTURE STRUCT SIGNATURE SIG
  LET IN END IF THEN ELSE
  ORELSE ANDALSO NOT
  NIL WITH OF OP

%prefer THEN ELSE LPAREN

%value ID ("foo")
%value INT (1)
%value STRING ("")
%value BIT (Bit.fromInt(0))
%value REAL (1.0)

%change -> IN ID END
      | EQ -> ASSIGN
      | ASSIGN -> EQ
      | SEMICOLON ELSE -> ELSE
      | LET ID EQ -> LET TYPE ID EQ
      | LET ID ASSIGN -> LET VAL ID ASSIGN
      | LET ID COLON ID ASSIGN -> LET VAL ID COLON ID ASSIGN
      | LET ID LPAREN -> LET FUN ID LPAREN
      | COMMA -> SEMICOLON
      | SEMICOLON -> COMMA
      | SEMICOLON -> COLON
      | COLON -> SEMICOLON
      | SEMICOLON THEN -> THEN
      | SEMICOLON VAL -> VAL
      | SEMICOLON TYPE -> TYPE
      | SEMICOLON FUN -> FUN
      | SEMICOLON DATATYPE -> DATATYPE
      | SEMICOLON MODULE -> MODULE
      | SEMICOLON END -> END
      | SEMICOLON IN -> IN

%nonassoc ID
%nonassoc OF
%nonassoc ASSIGN
%nonassoc THEN
%nonassoc ELSE
%nonassoc LBRACK RBRACK
%left ORELSE
%left ANDALSO
%nonassoc EQ NEQ GT LT GE LE
%left REAL_MINUS REAL_PLUS INT_MINUS INT_PLUS BIT_XOR BIT_OR
%left REAL_DIVIDE REAL_TIMES INT_DIVIDE INT_TIMES BIT_AND
%left UMINUS BIT_NOT

%%

program	      : exp                                                         ()

exp           : INT                                                         ()
              | STRING                                                      ()
              | REAL                                                        ()
              | BIT                                                         ()
              | NIL                                                         ()
              | lvalue                                                      ()
              | operation                                                   ()
              | let_block                                                   ()
              | exp_seq                                                     ()
              | assign                                                      ()
              | fun_call                                                    ()
              | conditional                                                 ()
              | insts                                                       ()
              | LPAREN RPAREN                                               ()

lvalue        : ID                                                          ()
              | subscript                                                   ()
              | field                                                       ()

subscript     : ID LBRACK exp RBRACK                                        ()
              | lvalue LBRACK exp RBRACK                                    ()

field         : lvalue DOT ID                                               ()

operation     : int_op                                                      ()
              | real_op                                                     ()
              | bit_op                                                      ()
              | compare_op                                                  ()

int_op        : INT_MINUS exp %prec UMINUS                                  ()
              | exp INT_PLUS exp                                            ()
              | exp INT_MINUS exp                                           ()
              | exp INT_TIMES exp                                           ()
              | exp INT_DIVIDE exp                                          ()
              | exp INT_MOD exp                                             ()

real_op       : INT_MINUS exp %prec UMINUS                                  ()
              | exp REAL_PLUS exp                                           ()
              | exp REAL_MINUS exp                                          ()
              | exp REAL_TIMES exp                                          ()
              | exp REAL_DIVIDE exp                                         ()

bit_op        : BIT_NOT exp                                                 ()
              | exp BIT_OR exp                                              ()
              | exp BIT_AND exp                                             ()
              | exp BIT_XOR exp                                             ()
              | exp BIT_SLL exp                                             ()
              | exp BIT_SRL exp                                             ()
              | exp BIT_SRA exp                                             ()

compare_op    : exp EQ exp                                                  ()
              | exp NEQ exp                                                 ()
              | exp GT exp                                                  ()
              | exp LT exp                                                  ()
              | exp GE exp                                                  ()
              | exp LE exp                                                  ()

let_block     : LET decs IN let_body END                                    ()

decs          : val_dec decs                                                ()
              | fun_dec non_fun_dec                                         ()
              | ty_dec non_ty_dec                                           ()
              | dataty_dec non_dataty_dec                                   ()
              | module_dec non_module_dec                                   ()
              | epsilon                                                     ()

non_fun_dec   : val_dec decs                                                ()
              | ty_dec non_ty_dec                                           ()
              | dataty_dec non_dataty_dec                                   ()
              | module_dec non_module_dec                                   ()
              | epsilon                                                     ()

non_ty_dec    : val_dec decs                                                ()
              | fun_dec non_fun_dec                                         ()
              | dataty_dec non_dataty_dec                                   ()
              | module_dec non_module_dec                                   ()
              | epsilon                                                     ()

non_dataty_dec: val_dec decs                                                ()
              | ty_dec non_ty_dec                                           ()
              | fun_dec non_fun_dec                                         ()
              | module_dec non_module_dec                                   ()
              | epsilon                                                     ()

non_module_dec: val_dec decs                                                ()
              | fun_dec non_fun_dec                                         ()
              | ty_dec non_ty_dec                                           ()
              | dataty_dec non_dataty_dec                                   ()
              | epsilon                                                     ()

val_dec       : VAL ID EQ exp                                               ()
              | VAL ID COLON ID EQ exp                                      ()

fun_dec       : fun_dec_no_type                                             ()
              | fun_dec_with_type                                           ()
              | fun_dec_no_type fun_dec                                     ()
              | fun_dec_with_type fun_dec                                   ()

fun_dec_no_type: FUN ID fun_params EQ exp                                   ()

fun_dec_with_type: FUN ID fun_params COLON ID EQ exp                        ()

fun_params    : fun_param fun_params                                        ()
              | fun_param                                                   ()

fun_param     : LPAREN ID RPAREN                                            ()
              | ID                                                          ()
              | LPAREN ty_fields RPAREN                                     ()

ty_dec        : TYPE ID EQ ty                                               ()
              | TYPE ID EQ ty ty_dec                                        ()

ty            : ID                                                          ()
              | ty INT_TIMES ty                                             ()
              | LBRACE ty_fields RBRACE                                     ()
              | ty AT INT                                                   ()
              | ty LBRACK INT RBRACK                                        ()
              | ty LBRACK RBRACK                                            ()
              | ty INT_MINUS GT ty                                          ()
              | ty LIST                                                     ()

ty_fields     : ty_field_tail                                               ()
              | epsilon                                                     ()

ty_field_tail : ID COLON ty                                                 ()
              | ty_field_tail COMMA ID COLON ty                             ()

let_body      : exp semicolon_exp0                                          ()

semicolon_exp0: SEMICOLON exp semicolon_exp0                                ()
              | epsilon                                                     ()

exp_seq       : LPAREN exp RPAREN                                           ()
              | LPAREN exp semicolon_exp1 RPAREN                            ()

semicolon_exp1: SEMICOLON exp semicolon_exp1                                ()
              | SEMICOLON exp                                               ()

assign        : lvalue ASSIGN exp                                           ()

fun_call      : ID call_params                                              ()

call_params   : call_param call_params                                      ()
              | epsilon                                                     ()

call_param    : LPAREN exp exp_comma_tail RPAREN                            ()
              | exp                                                         ()

exp_comma_tail: COMMA exp exp_comma_tail                                    ()
              | epsilon                                                     ()

conditional   : IF exp THEN exp ELSE exp                                    ()
              | IF exp THEN exp                                             ()
              | exp ANDALSO exp                                             ()
              | exp ORELSE exp                                              ()

insts         : rec_inst                                                    ()
              | ref_inst                                                    ()
              | array_inst                                                  ()
              | list_inst                                                   ()

rec_inst      : LBRACE rec_inst_body RBRACE                                 ()

rec_inst_body : ID EQ exp rec_field_comma_tail                              ()
              | epsilon                                                     ()

rec_field_comma_tail
              : COMMA ID EQ exp rec_field_comma_tail                        ()
              | epsilon                                                     ()

ref_inst      : REF exp                                                     ()

array_inst    : POUND LBRACK exp exp_comma_tail RBRACK                      ()
              | POUND LBRACK exp COMMA array_index_fn RBRACK                ()

array_index_fn: ID EQ GT exp index_fn_tail                                  ()
              | INT EQ GT exp index_fn_tail                                 ()

index_fn_tail : PIPE ID EQ GT exp index_fn_tail                             ()
              | PIPE INT EQ GT exp index_fn_tail                            ()
              | epsilon                                                     ()

list_inst     : LBRACK list_elements RBRACK                                 ()

list_elements : exp exp_comma_tail                                          ()
              | epsilon                                                     ()

epsilon       :                                                             ()
