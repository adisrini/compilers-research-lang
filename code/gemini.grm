%%
%term
    EOF
  | DATATYPE | TYPE | VAL | REF | FUN | MODULE | STRUCTURE | STRUCT | SIGNATURE | SIG
  | LET | IN | END | IF | THEN | ELSE
  | ORELSE | ANDALSO | NOT
  | NIL | WITH | OF | OP
  | BIT_NOT | BIT_OR | BIT_AND | BIT_XOR | BIT_SLL | BIT_SRL | BIT_SRA
  | GE | GT | LE | LT | NEQ | EQ
  | INT_DIVIDE | INT_TIMES | INT_PLUS | INT_MINUS | INT_MOD | REAL_DIVIDE | REAL_TIMES | REAL_PLUS | REAL_MINUS
  | RBRACE | LBRACE | RBRACK | LBRACK | RPAREN | LPAREN
  | DOT | SEMICOLON | COLON | COMMA | POUND | AT | TICK | ASSIGN
  | ID of string | INT of int | STRING of string | REAL of real | BIT of Bit.bit
  | UMINUS

%nonterm  program
        | exp
            | lvalue
                | subscript
                | field
            | operation
                | int_op
                | real_op
                | bit_op
                | compare_op
            | let_block
                | let_body
                | decs
                    | var_dec
                    | fun_dec
                    | module_dec
                    | ty_dec
                    | ty_or_var_dec
                    | var_or_fun_dec
            | exp_seq

        | ty
        | tyfields
        | tyfieldtail
        | letbody
        | expSCtail
        | expseq
        | expseqtail
        | funcall
        | callParams
        | expCtail
        | assign
        | recdec
        | recdecbody
        | fieldCtail
        | arraydec
        | ifthenelse
        | epsilon

%pos int
%verbose
%start program
%eop EOF
%noshift EOF

%name Gemini

%keyword DATATYPE TYPE VAL REF FUN MODULE STRUCTURE STRUCT SIGNATURE SIG
  LET IN END IF THEN ELSE
  ORELSE ANDALSO NOT
  NIL WITH OF OP

%prefer THEN ELSE LPAREN

%value ID ("foo")
%value INT (1)
%value STRING ("")
%value BIT (Bit.fromInt(0))
%value REAL (1.0)

%change -> IN ID END
      | EQ -> ASSIGN
      | ASSIGN -> EQ
      | SEMICOLON ELSE -> ELSE
      | LET ID EQ -> LET TYPE ID EQ
      | LET ID ASSIGN -> LET VAL ID ASSIGN
      | LET ID COLON ID ASSIGN -> LET VAL ID COLON ID ASSIGN
      | LET ID LPAREN -> LET FUN ID LPAREN
      | COMMA -> SEMICOLON
      | SEMICOLON -> COMMA
      | SEMICOLON -> COLON
      | COLON -> SEMICOLON
      | SEMICOLON THEN -> THEN
      | SEMICOLON VAL -> VAL
      | SEMICOLON TYPE -> TYPE
      | SEMICOLON FUN -> FUN
      | SEMICOLON DATATYPE -> DATATYPE
      | SEMICOLON MODULE -> MODULE
      | SEMICOLON END -> END
      | SEMICOLON IN -> IN

%nonassoc ID
%nonassoc OF
%nonassoc ASSIGN
%nonassoc THEN
%nonassoc ELSE
%nonassoc LBRACK RBRACK
%left ORELSE
%left ANDALSO
%nonassoc EQ NEQ GT LT GE LE
%left REAL_MINUS REAL_PLUS INT_MINUS INT_PLUS BIT_XOR BIT_OR
%left REAL_DIVIDE REAL_TIMES INT_DIVIDE INT_TIMES BIT_AND
%left UMINUS BIT_NOT

%%

program	      : exp                                                         ()

exp           : INT                                                         ()
              | STRING                                                      ()
              | REAL                                                        ()
              | BIT                                                         ()
              | NIL                                                         ()
              | lvalue                                                      ()
              | operation                                                   ()
              | let_block                                                   ()
              | exp_seq                                                      ()
              | assign                                                      ()
              | funcall                                                     ()
              | arraydec                                                    ()
              | recdec                                                      ()
              | ifthenelse                                                  ()
              | LPAREN RPAREN                                               ()

lvalue        : ID                                                          ()
              | subscript                                                   ()
              | field                                                       ()

subscript     : ID LBRACK exp RBRACK                                        ()
              | lvalue LBRACK exp RBRACK                                    ()

field         : lvalue DOT ID                                               ()

operation     : int_op                                                      ()
              | real_op                                                     ()
              | bit_op                                                      ()
              | compare_op                                                  ()

int_op        : MINUS exp %prec UMINUS                                      ()
              | exp INT_PLUS exp                                            ()
              | exp INT_MINUS exp                                           ()
              | exp INT_TIMES exp                                           ()
              | exp INT_DIVIDE exp                                          ()
              | exp INT_MOD exp                                             ()

real_op       : MINUS exp %prec UMINUS                                      ()
              | exp REAL_PLUS exp                                           ()
              | exp REAL_MINUS exp                                          ()
              | exp REAL_TIMES exp                                          ()
              | exp REAL_DIVIDE exp                                         ()

bit_op        : BIT_NOT exp                                                 ()
              | exp BIT_OR exp                                              ()
              | exp BIT_AND exp                                             ()
              | exp BIT_XOR exp                                             ()
              | exp BIT_SLL exp                                             ()
              | exp BIT_SRL exp                                             ()
              | exp BIT_SRA exp                                             ()

compare_op    : exp EQ exp                                                  ()
              | exp NEQ exp                                                 ()
              | exp GT exp                                                  ()
              | exp LT exp                                                  ()
              | exp GE exp                                                  ()
              | exp LE exp                                                  ()

let_block     : LET decs IN let_body END                                    ()

decs          : var_dec decs                                                ()
              | fun_dec non_fun_dec                                         ()
              | ty_dec non_ty_dec                                           ()
              | module_dec non_module_dec                                   ()
              | epsilon                                                     ()

var_dec       : VAR ID EQ exp                                               ()
              | VAR ID COLON ID EQ exp                                      ()

non_fun_dec   : tydec varOrFunDec                                           ()
              | vardec decs                                                 ()
              | epsilon                                                     ()

non_ty_dec    : vardec decs                                                 ()
              | fundec tyOrVarDec                                           ()
              | epsilon                                                     ()

non_module_dec: vardec decs                                                 ()
              | fundec tyOrVarDec                                           ()
              | epsilon                                                     ()

tydec         : TYPE ID EQ ty                                               ()
              | TYPE ID EQ ty tydec                                         ()

ty            : ID                                                          ()
              | LBRACE tyfields RBRACE                                      ()
              | ARRAY OF ID                                                 ()

tyfields      : tyfieldtail                                                 ()
              | epsilon                                                     ()

tyfieldtail   : ID COLON ID                                                 ()
              | tyfieldtail COMMA ID COLON ID                               ()

fundec        : FUNCTION ID LPAREN tyfields RPAREN EQ exp                   ()
              | FUNCTION ID LPAREN tyfields RPAREN COLON ID EQ exp          ()
              | FUNCTION ID LPAREN tyfields RPAREN EQ exp fundec            ()
              | FUNCTION ID LPAREN tyfields RPAREN COLON ID EQ exp fundec   ()

let_body      : exp expSCtail                                               ()
              | epsilon                                                     ()

expSCtail     : SEMICOLON exp expSCtail                                     ()
              | epsilon                                                     ()

whileloop     : WHILE exp DO exp                                            ()

forloop       : FOR ID ASSIGN exp TO exp DO exp                             ()

expseq        : LPAREN exp RPAREN                                           ()
              | LPAREN exp expseqtail RPAREN                                ()

expseqtail    : SEMICOLON exp                                               ()
              | SEMICOLON exp expseqtail                                    ()

funcall       : ID LPAREN callParams RPAREN                                 ()

callParams    : exp expCtail                                                ()
              | epsilon                                                     ()

expCtail      : COMMA exp expCtail                                          ()
              | epsilon                                                     ()

assign        : lvalue ASSIGN exp                                           ()

fieldCtail    : COMMA ID EQ exp fieldCtail                                  ()
              | epsilon                                                     ()

recdecbody    : ID EQ exp fieldCtail                                        ()
              | epsilon                                                     ()

recdec        : ID LBRACE recdecbody RBRACE                                 ()


arraydec      : ID LBRACK exp RBRACK OF exp                                 ()

ifthenelse    : IF exp THEN exp ELSE exp                                    ()
              | IF exp THEN exp                                             ()
              | exp AND exp                                                 ()
              | exp OR exp                                                  ()

epsilon       :                                                             ()
